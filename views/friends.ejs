<section class="friends">
  <h1>ì¹œêµ¬ ê´€ë¦¬</h1>

  <% if (!user) { %>
    <p>ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <a class="btn" href="/login">ë¡œê·¸ì¸í•˜ê¸°</a>
  <% } else { %>

  <!-- ğŸ” ì¹œêµ¬ ê²€ìƒ‰ -->
  <div class="search-box">
    <input id="searchInput" type="text" placeholder="ì¹œêµ¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
    <button id="searchBtn" class="btn">ê²€ìƒ‰</button>
  </div>

  <!-- ê²€ìƒ‰ ê²°ê³¼ -->
  <div id="searchResults" class="results"></div>

  <hr />

  <!-- ğŸ‘¥ ë‚´ ì¹œêµ¬ ëª©ë¡ -->
  <h2>ë‚´ ì¹œêµ¬ ëª©ë¡</h2>
  <ul id="friendsList" class="friends-list"></ul>

  <% } %>
</section>

<script>
  const searchBtn = document.getElementById('searchBtn');
  const searchInput = document.getElementById('searchInput');
  const searchResults = document.getElementById('searchResults');
  const friendsList = document.getElementById('friendsList');

  let myFriends = []; // í˜„ì¬ ë‚´ ì¹œêµ¬ ëª©ë¡ì„ ì €ì¥ (ê²€ìƒ‰ ì‹œ ë²„íŠ¼ í† ê¸€ìš©)

  // âœ… ë‚´ ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadFriends() {
    try {
      const res = await fetch('/api/friends', { credentials: 'include' });
      if (!res.ok) throw new Error('ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨');
      const data = await res.json();
      myFriends = data;

      if (!data.length) {
        friendsList.innerHTML = '<li class="muted">ì•„ì§ ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        return;
      }

      friendsList.innerHTML = data
        .map(
          f => `
          <li class="friend-item">
            <span>@${f.username}</span>
            <button class="btn ghost" onclick="removeFriend('${f._id}')">ì‚­ì œ</button>
          </li>
        `
        )
        .join('');
    } catch (err) {
      console.error(err);
      friendsList.innerHTML = '<li class="muted">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>';
    }
  }

  // âœ… ì¹œêµ¬ ê²€ìƒ‰
  async function searchUsers() {
    const keyword = searchInput.value.trim();
    if (!keyword) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
    searchResults.innerHTML = '<p class="muted">ê²€ìƒ‰ ì¤‘...</p>';
    try {
      const res = await fetch(`/api/friends/search?username=${encodeURIComponent(keyword)}`, {
        credentials: 'include'
      });
      if (!res.ok) throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨');
      const users = await res.json();

      if (!users.length) {
        searchResults.innerHTML = '<p class="muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
      }

      // ğŸ”„ ì´ë¯¸ ì¹œêµ¬ì¸ì§€ íŒë‹¨
      searchResults.innerHTML = users
        .map(u => {
          const isFriend = myFriends.some(f => f._id === u._id);
          return `
            <div class="user-item">
              <span>@${u.username}</span>
              ${
                isFriend
                  ? `<button class="btn ghost" onclick="removeFriend('${u._id}')">ì‚­ì œ</button>`
                  : `<button class="btn" onclick="addFriend('${u._id}')">ì¶”ê°€</button>`
              }
            </div>
          `;
        })
        .join('');
    } catch (err) {
      searchResults.innerHTML = '<p class="muted">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>';
    }
  }

  // âœ… ì¹œêµ¬ ì¶”ê°€
  async function addFriend(friendId) {
    try {
      const res = await fetch('/api/friends/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ friendId }),
      });
      const data = await res.json();
      if (res.ok) {
        alert('ì¹œêµ¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        loadFriends();
        searchUsers();
      } else {
        alert(data.message || 'ì¶”ê°€ ì‹¤íŒ¨');
      }
    } catch {
      alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // âœ… ì¹œêµ¬ ì‚­ì œ
  async function removeFriend(friendId) {
    if (!confirm('ì •ë§ ì´ ì¹œêµ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    try {
      const res = await fetch('/api/friends/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ friendId }),
      });
      const data = await res.json();
      if (res.ok) {
        alert('ì¹œêµ¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        loadFriends();
        searchUsers();
      } else {
        alert(data.message || 'ì‚­ì œ ì‹¤íŒ¨');
      }
    } catch {
      alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ì´ë²¤íŠ¸
  searchBtn.addEventListener('click', searchUsers);
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchUsers();
  });

  // í˜ì´ì§€ ì§„ì… ì‹œ ë‚´ ì¹œêµ¬ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
  loadFriends();
</script>

<style>
.friends {
  max-width: 600px;
  margin: 0 auto;
  text-align: center;
}
.search-box {
  display: flex;
  justify-content: center;
  gap: 8px;
  margin: 20px 0;
}
.results {
  margin-top: 10px;
}
.user-item, .friend-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  border: 1px solid #eee;
  border-radius: 6px;
  margin: 6px 0;
}
.friends-list {
  list-style: none;
  padding: 0;
}
.friends-list li {
  margin: 4px 0;
}
.btn {
  padding: 6px 10px;
  background: #111;
  color: #fff;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}
.btn.ghost {
  background: transparent;
  border: 1px solid #111;
  color: #111;
}
.muted {
  color: #777;
}
</style>
