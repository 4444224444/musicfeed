<section class="home">
  <% if (!user) { %>
    <div class="placeholder">
      <h2>ë¡œê·¸ì¸ í›„ Spotifyë¥¼ ì—°ë™í•´ ë³´ì„¸ìš” ğŸ§</h2>
      <div class="actions">
        <a class="btn" href="/login">Login</a>
        <a class="btn ghost" href="/register">Sign up</a>
      </div>
    </div>

  <% } else if (!user.linkedSpotify) { %>
    <div class="placeholder">
      <h2>@<%= user.username %> ë‹˜, Spotify ì—°ë™ì´ í•„ìš”í•´ìš” ğŸ¶</h2>
      <p class="muted">ì—°ë™í•˜ë©´ í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
      <a class="btn" href="/api/spotify/login">Spotify ì—°ë™í•˜ëŸ¬ ê°€ê¸°</a>
    </div>

  <% } else { %>
    <div id="np-empty" class="placeholder">
      <h2>í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</h2>
      <p class="muted">ìŒì•…ì´ ì‹œì‘ë˜ë©´ ì—¬ê¸°ì—ì„œ ë°”ë¡œ ë³´ì—¬ë“œë¦´ê²Œìš”.</p>
    </div>

    <script>
      (function () {
        async function refresh() {
          try {
            const res = await fetch('/api/spotify/current', { credentials: 'include' });
            if (!res.ok) return;
            const d = await res.json();

            const container = document.querySelector('.home');

            if (!d || !d.trackName || d.is_playing === false) {
              const empty = document.getElementById('np-empty');
              if (!empty && container) {
                container.insertAdjacentHTML('afterbegin', `
                  <div id="np-empty" class="placeholder">
                    <h2>í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</h2>
                    <p class="muted">ìŒì•…ì´ ì‹œì‘ë˜ë©´ ì—¬ê¸°ì—ì„œ ë°”ë¡œ ë³´ì—¬ë“œë¦´ê²Œìš”.</p>
                  </div>
                `);
              }
              return;
            }

            const html = `
              <div id="np" class="now-playing">
                <img class="cover" src="${d.albumCover || ''}" alt="album cover" />
                <div class="meta">
                  <h2>${d.trackName}</h2>
                  <p>${d.artist || ''}</p>
                  <small class="muted">ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}</small>
                </div>
              </div>`;
            const empty = document.getElementById('np-empty');
            if (empty) empty.outerHTML = html;
            else {
              const np = document.getElementById('np');
              if (np) np.outerHTML = html; else if (container) container.insertAdjacentHTML('afterbegin', html);
            }
          } catch (e) { /* ignore */ }
        }

        // í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ 1íšŒ + ì£¼ê¸° í´ë§
        refresh();
        setInterval(refresh, 15000);
      })();
    </script>
  <% } %>
</section>

<style>
.home{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;text-align:center}
.placeholder{padding:32px 24px;border:1px dashed #ddd;border-radius:16px;background:#fff}
.actions{margin-top:12px;display:flex;gap:8px;justify-content:center}
.btn{display:inline-block;padding:10px 16px;border-radius:8px;background:#111;color:#fff;text-decoration:none}
.btn.ghost{background:transparent;border:1px solid #111;color:#111}
.muted{color:#777}
.now-playing{display:flex;flex-direction:column;align-items:center;gap:14px}
.cover{width:240px;height:240px;object-fit:cover;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.2)}
.meta h2{margin:0 0 6px}
.meta p{margin:0}
</style>
